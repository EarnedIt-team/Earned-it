<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ÌçºÏ¶ê Ïä¨Î°Ø Í∑∏Î¶¨Îìú Ìé∏Ïßë</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
        }

        h2 {
            font-weight: bold;
            color: #007bff;
        }

        .layout {
            display: grid;
            grid-template-columns: 1fr 260px;
            gap: 2rem;
        }

        @media (max-width: 991px) {
            .layout {
                grid-template-columns: 1fr;
            }
        }

        .theme-section {
            margin-bottom: 60px;
        }

        .grid-table {
            width: 100%;
            table-layout: fixed;
        }

        .slot-box {
            width: 120px;
            height: 140px;
            border: 1px solid #ccc;
            text-align: center;
            vertical-align: top;
            background-color: #f8f8f8;
            position: relative;
            padding: 5px;
        }

        .slot-box img {
            max-width: 90%;
            max-height: 60px;
            margin-top: 6px;
        }

        .dragging {
            opacity: 0.5;
        }

        .item-palette {
            background-color: #ffffff;
            border: 1px solid #ccc;
            padding: 1rem;
            overflow-y: auto;
            max-height: 80vh;
            border-radius: 8px;
        }

        .palette-item {
            border: 1px solid #ddd;
            padding: 0.5rem;
            margin-bottom: 0.75rem;
            text-align: center;
            cursor: grab;
            background-color: #fdfdfd;
            border-radius: 6px;
        }

        .palette-item img {
            max-width: 100%;
            max-height: 50px;
        }

        .theme-title {
            font-weight: bold;
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
            font-size: 1.2rem;
        }
    </style>
</head>
<body class="container mt-4">

<h2 class="mb-4">üß© ÌçºÏ¶ê Ïä¨Î°Ø Í∑∏Î¶¨Îìú Ìé∏Ïßë</h2>

<div class="layout">
    <!-- ÌçºÏ¶ê Í∑∏Î¶¨Îìú -->
    <div>
        <div th:each="entry : ${gridMap}" class="theme-section">
            <div class="theme-title" th:text="'ÌÖåÎßà: ' + ${entry.key}"></div>
            <table class="grid-table">
                <tr th:each="row : ${entry.value}">
                    <td th:each="slot : ${row}"
                        class="slot-box"
                        th:attr="data-slot-id=${slot?.id}"
                        ondrop="drop(event)"
                        ondragover="allowDrop(event)">

                        <div th:if="${slot != null}"
                             draggable="true"
                             ondragstart="drag(event)"
                             th:attr="data-id=${slot.id}"
                             th:id="'slot-' + ${slot.id}">

                            <img th:src="${slot.item.image}" alt="Ïù¥ÎØ∏ÏßÄ" onerror="this.src='/images/placeholder.png'">
                            <div th:text="${slot.item.name}"></div>
                            <small th:text="'Index: ' + ${slot.slotIndex}"></small>
                        </div>

                    </td>
                </tr>
            </table>
        </div>
    </div>

    <!-- ÏïÑÏù¥ÌÖú Î™©Î°ù -->
    <div class="item-palette">
        <h5>üß∫ ÏïÑÏù¥ÌÖú Î™©Î°ù</h5>
        <div th:each="item : ${items}" class="palette-item"
             draggable="true"
             ondragstart="dragNewItem(event)"
             th:attr="data-item-id=${item.id}">
            <img th:src="${item.image}" alt="Ïù¥ÎØ∏ÏßÄ" onerror="this.src='/images/placeholder.png'">
            <div th:text="${item.name}"></div>
        </div>
    </div>
</div>

<script>
    let dragged = null;
    let newItemId = null;

    function allowDrop(ev) {
        ev.preventDefault();
    }

    function drag(ev) {
        dragged = ev.target;
        newItemId = null;
        ev.dataTransfer.setData("text", ev.target.id);
    }

    function dragNewItem(ev) {
        dragged = null;
        newItemId = ev.target.getAttribute('data-item-id');
    }

    function drop(ev) {
        ev.preventDefault();
        const target = ev.target.closest(".slot-box");
        if (!target) return;

        const slotId = target.getAttribute("data-slot-id");

        if (newItemId) {
            fetch(`/admin/puzzle-slots/replace?slotId=${slotId}&itemId=${newItemId}`, { method: 'POST' })
                .then(() => location.reload());
        } else if (dragged) {
            const fromSlot = dragged.closest(".slot-box");
            const toSlot = target;
            if (fromSlot === toSlot) return;

            const fromContent = fromSlot.innerHTML;
            const toContent = toSlot.innerHTML;
            fromSlot.innerHTML = toContent;
            toSlot.innerHTML = fromContent;

            const fromId = fromSlot.getAttribute('data-slot-id');
            const toId = toSlot.getAttribute('data-slot-id');
            fetch(`/admin/puzzle-slots/swap?from=${fromId}&to=${toId}`, { method: 'POST' });
        }
    }
</script>
</body>
</html>