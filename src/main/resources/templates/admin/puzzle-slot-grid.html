<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>í¼ì¦ ìŠ¬ë¡¯ ê·¸ë¦¬ë“œ í¸ì§‘</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
        }

        h2 {
            font-weight: bold;
            color: #007bff;
        }

        .layout {
            display: flex;
            flex-wrap: wrap;
            gap: 2rem;
        }

        .grid-container {
            flex: 1;
            min-width: 300px;
        }

        .item-palette {
            width: 260px;
            background-color: #ffffff;
            border: 1px solid #ccc;
            padding: 1rem;
            overflow-y: auto;
            max-height: 80vh;
            border-radius: 8px;
        }

        .theme-section {
            margin-bottom: 60px;
        }

        .grid-table {
            border-collapse: collapse;
        }

        .slot-box {
            width: 120px;
            height: 140px;
            border: 1px solid #ccc;
            text-align: center;
            background-color: #f8f8f8;
            padding: 5px;
        }

        .slot-box img {
            max-width: 80px;
            max-height: 60px;
            object-fit: contain;
        }

        .dragging {
            opacity: 0.5;
        }

        .palette-item {
            border: 1px solid #ddd;
            padding: 0.5rem;
            margin-bottom: 0.75rem;
            text-align: center;
            cursor: grab;
            background-color: #fdfdfd;
            border-radius: 6px;
        }

        .palette-item img {
            max-width: 100%;
            max-height: 50px;
            object-fit: contain;
        }

        .theme-title {
            font-weight: bold;
            margin-bottom: 0.5rem;
            font-size: 1.2rem;
        }

        .item-controls {
            margin-top: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: center;
        }

        .section-divider {
            margin-top: 40px;
            margin-bottom: 10px;
            font-weight: bold;
            font-size: 1.1rem;
            border-bottom: 1px solid #ccc;
            padding-bottom: 5px;
        }

        @media (max-width: 768px) {
            .layout {
                flex-direction: column;
            }

            .item-palette {
                width: 100%;
            }
        }
    </style>
</head>
<body class="container mt-4">

<h2 class="mb-4">ğŸ§© í¼ì¦ ìŠ¬ë¡¯ ê·¸ë¦¬ë“œ í¸ì§‘</h2>

<div class="layout">
    <!-- í¼ì¦ ê·¸ë¦¬ë“œ -->
    <div class="grid-container">
        <div th:each="entry : ${gridMap}" class="theme-section">
            <div class="theme-title" th:text="'í…Œë§ˆ: ' + ${entry.key}"></div>
            <table class="grid-table">
                <tr th:each="row, rowStat : ${entry.value}">
                    <th:block th:each="slot, colStat : ${row}">
                        <td th:if="${slot != null && slot.item != null}"
                            class="slot-box"
                            th:attr="data-slot-id=${slot.id}"
                            ondrop="drop(event)"
                            ondragover="allowDrop(event)">
                            <div draggable="true"
                                 ondragstart="drag(event)"
                                 th:attr="data-id=${slot.id}"
                                 th:id="'slot-' + ${slot.id}">
                                <img th:src="${slot.item.image}" alt="ì´ë¯¸ì§€" onerror="this.src='/images/placeholder.png'">
                                <div th:text="${slot.item.name}"></div>
                                <small th:text="'Index: ' + ${slot.slotIndex}"></small>
                            </div>
                        </td>
                    </th:block>
                </tr>
            </table>
        </div>
    </div>

    <!-- ì•„ì´í…œ ëª©ë¡ -->
    <div class="item-palette">
        <h5>ğŸ§º ì•„ì´í…œ ëª©ë¡</h5>
        <div th:each="item : ${items}" class="palette-item"
             draggable="true"
             ondragstart="dragNewItem(event)"
             th:attr="data-item-id=${item.id}">
            <img th:src="${item.image}" alt="ì´ë¯¸ì§€" onerror="this.src='/images/placeholder.png'">
            <div th:text="${item.name}"></div>
        </div>
    </div>
</div>

<!-- ë²„íŠ¼ ì„¹ì…˜ ë¶„ë¦¬ -->
<div class="item-controls text-center">
    <div class="section-divider">ğŸ”§ ê¸°ëŠ¥</div>
    <a href="/admin/puzzle-slots/new" class="btn btn-success mb-2" style="max-width: 200px;">
        â• í¼ì¦ ìŠ¬ë¡¯ ì¶”ê°€/ìˆ˜ì •
    </a>
    <a href="/admin" class="btn btn-secondary" style="max-width: 200px;">
        ëŒ€ì‹œë³´ë“œë¡œ ì´ë™
    </a>
</div>

<!-- ì‚¬ìš© ì„¤ëª… ì„¹ì…˜ -->
<div class="section-divider">ğŸ“˜ ì‚¬ìš© ê°€ì´ë“œ</div>
<ul>
    <li>ì•„ì´í…œì„ í¼ì¦ ìŠ¬ë¡¯ì— <strong>ë“œë˜ê·¸í•˜ì—¬ ì‚½ì…</strong>í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
    <li>ìŠ¬ë¡¯ ê°„ ë“œë˜ê·¸ë¡œ <strong>ìœ„ì¹˜ë¥¼ ë³€ê²½</strong>í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
    <li>í¼ì¦ ìŠ¬ë¡¯ì„ ì‚­ì œí•˜ê³  ì‹¶ë‹¤ë©´ í¼ì¦ ìŠ¬ë¡¯ ì¶”ê°€/ìˆ˜ì • í˜ì´ì§€ì—ì„œ ê´€ë¦¬í•˜ì„¸ìš”.</li>
</ul>

<script>
    let dragged = null;
    let newItemId = null;

    function allowDrop(ev) {
        ev.preventDefault();
    }

    function drag(ev) {
        dragged = ev.target;
        newItemId = null;
        ev.dataTransfer.setData("text", ev.target.id);
    }

    function dragNewItem(ev) {
        dragged = null;
        newItemId = ev.target.getAttribute('data-item-id');
    }

    function drop(ev) {
        ev.preventDefault();
        const target = ev.target.closest(".slot-box");
        if (!target) return;

        const slotId = target.getAttribute("data-slot-id");

        if (newItemId) {
            if (slotId === "-1") {
                const theme = target.getAttribute("data-theme");
                const index = target.getAttribute("data-index");

                fetch(`/admin/puzzle-slots/create?theme=${theme}&index=${index}&itemId=${newItemId}`, {
                    method: 'POST'
                }).then(() => location.reload());
            } else {
                fetch(`/admin/puzzle-slots/replace?slotId=${slotId}&itemId=${newItemId}`, {
                    method: 'POST'
                }).then(() => location.reload());
            }
        } else if (dragged) {
            const fromSlot = dragged.closest(".slot-box");
            const toSlot = target;
            if (fromSlot === toSlot) return;

            const fromId = fromSlot.getAttribute('data-slot-id');
            const toId = toSlot.getAttribute('data-slot-id');

            fetch(`/admin/puzzle-slots/swap?from=${fromId}&to=${toId}`, {
                method: 'POST'
            }).then(() => location.reload());
        }
    }
</script>

</body>
</html>