<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ÌçºÏ¶ê Ïä¨Î°Ø Í∑∏Î¶¨Îìú Ìé∏Ïßë</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .slot-box {
            width: 120px;
            height: 140px;
            border: 1px solid #ccc;
            text-align: center;
            vertical-align: top;
            background-color: #f8f8f8;
            position: relative;
        }
        .slot-box img {
            max-width: 90%;
            max-height: 60px;
            margin-top: 8px;
        }
        .theme-section {
            margin-bottom: 50px;
        }
        .dragging {
            opacity: 0.5;
        }
        .item-palette {
            position: fixed;
            right: 2rem;
            top: 5rem;
            width: 250px;
            background-color: #ffffff;
            border: 1px solid #ccc;
            padding: 1rem;
            overflow-y: auto;
            max-height: 80vh;
        }
        .palette-item {
            border: 1px solid #ddd;
            padding: 5px;
            margin-bottom: 10px;
            text-align: center;
            cursor: grab;
        }
        .palette-item img {
            max-width: 100%;
            max-height: 50px;
        }
    </style>
</head>
<body class="container mt-4">
<h2 class="mb-4">üß© ÌçºÏ¶ê Ïä¨Î°Ø Í∑∏Î¶¨Îìú Ìé∏Ïßë</h2>

<!-- ÌçºÏ¶ê Í∑∏Î¶¨Îìú -->
<div th:each="entry : ${gridMap}" class="theme-section">
    <h4 th:text="'ÌÖåÎßà: ' + ${entry.key}"></h4>
    <table>
        <tr th:each="row : ${entry.value}">
            <td th:each="slot : ${row}"
                class="slot-box"
                th:attr="data-slot-id=${slot?.id}"
                ondrop="drop(event)"
                ondragover="allowDrop(event)">

                <div th:if="${slot != null}"
                     draggable="true"
                     ondragstart="drag(event)"
                     th:attr="data-id=${slot.id}"
                     th:id="'slot-' + ${slot.id}">

                    <img th:src="${slot.item.image}" alt="Ïù¥ÎØ∏ÏßÄ" onerror="this.src='/images/placeholder.png'">
                    <div th:text="${slot.item.name}"></div>
                    <small th:text="'Index: ' + ${slot.slotIndex}"></small>
                </div>

            </td>
        </tr>
    </table>
</div>

<!-- ÏïÑÏù¥ÌÖú ÌåîÎ†àÌä∏ -->
<div class="item-palette">
    <h5>üß∫ ÏïÑÏù¥ÌÖú Î™©Î°ù</h5>
    <div th:each="item : ${allItems}" class="palette-item"
         draggable="true"
         ondragstart="dragNewItem(event)"
         th:attr="data-item-id=${item.id}">
        <img th:src="${item.image}" alt="Ïù¥ÎØ∏ÏßÄ" onerror="this.src='/images/placeholder.png'">
        <div th:text="${item.name}"></div>
    </div>
</div>

<script>
    let dragged = null;
    let newItemId = null;

    function allowDrop(ev) {
        ev.preventDefault();
    }

    function drag(ev) {
        dragged = ev.target;
        newItemId = null;
        ev.dataTransfer.setData("text", ev.target.id);
    }

    function dragNewItem(ev) {
        dragged = null;
        newItemId = ev.target.getAttribute('data-item-id');
    }

    function drop(ev) {
        ev.preventDefault();
        const target = ev.target.closest(".slot-box");
        if (!target) return;

        const slotId = target.getAttribute("data-slot-id");

        if (newItemId) {
            // ÏÉà ÏïÑÏù¥ÌÖúÏùÑ Ïä¨Î°ØÏóê ÏÇΩÏûÖ
            fetch(`/admin/puzzle-slots/replace?slotId=${slotId}&itemId=${newItemId}`, { method: 'POST' })
                .then(() => location.reload());
        } else if (dragged) {
            const fromSlot = dragged.closest(".slot-box");
            const toSlot = target;

            if (fromSlot === toSlot) return;

            // Swap UI
            const fromContent = fromSlot.innerHTML;
            const toContent = toSlot.innerHTML;
            fromSlot.innerHTML = toContent;
            toSlot.innerHTML = fromContent;

            const fromId = fromSlot.getAttribute('data-slot-id');
            const toId = toSlot.getAttribute('data-slot-id');

            // Persist
            fetch(`/admin/puzzle-slots/swap?from=${fromId}&to=${toId}`, { method: 'POST' });
        }
    }
</script>
</body>
</html>