<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <title>FCM ì „ì†¡ - ê´€ë¦¬ì</title>
  <style>
    body { font-family: 'Arial', sans-serif; margin: 2rem; background:#f6f7fb; color:#222; }
    .card { background:white; padding:1rem; border-radius:8px; box-shadow:0 6px 18px rgba(0,0,0,0.06); margin-bottom:1rem; }
    label { display:block; font-weight:600; margin-top:0.5rem; }
    input[type=text], textarea, select { width:100%; padding:8px; margin-top:6px; border-radius:6px; border:1px solid #ddd; }
    button { margin-top:12px; padding:8px 14px; border-radius:8px; border:0; cursor:pointer; background:#007bff; color:white; }
    .success { color:green; }
    .error { color:#b00020; }
    .templates { display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-top:12px; }
    .tpl { padding:10px; border-radius:6px; background:#fff; border:1px solid #eee; }
    .small-btn { padding:6px 8px; font-size:0.9rem; background:#28a745; color:white; border-radius:6px; border:0; cursor:pointer; }
  </style>
</head>
<body>
<h1>ğŸ“£ FCM ì „ì†¡ (ê´€ë¦¬ì)</h1>

<div th:if="${success}" class="card success" th:text="${success}"></div>
<div th:if="${error}" class="card error" th:text="${error}"></div>

<div class="card">
  <h3>ì¦‰ì‹œ ì „ì†¡ (ì§ì ‘ ì…ë ¥)</h3>
  <form th:action="@{/admin/fcm/send}" method="post">
    <label>Topic</label>
    <input type="text" name="topic" th:value="${defaultTopic}" placeholder="global_notifications" />

    <label>Title</label>
    <input type="text" name="title" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" required />

    <label>Body</label>
    <textarea name="body" rows="3" placeholder="ë³¸ë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”" required></textarea>

    <label>ë°ì´í„° (ì˜µì…˜, key=value í˜•íƒœë¡œ ì‰¼í‘œë¡œ êµ¬ë¶„)</label>
    <input type="text" name="data" placeholder="exampleKey=exampleValue,foo=bar" />

    <button type="submit">ì§€ê¸ˆ ì „ì†¡</button>
  </form>
  <p style="margin-top:8px; color:#666; font-size:0.9rem;">Tip: ê¸€ë¡œë²Œ ì „ì†¡ì„ ì›í•˜ë©´ topicì„ <code>global_notifications</code> ë¡œ ì‚¬ìš©í•˜ì„¸ìš”.</p>
</div>

<div class="card">
  <h3>í…œí”Œë¦¿ ëª©ë¡ (DB)</h3>
  <div class="templates">
    <div class="tpl" th:each="tpl : ${templates}">
      <div><strong th:text="${tpl.title}">ì œëª©</strong> <small style="color:#888" th:text="${tpl.category}">ì¹´í…Œê³ ë¦¬</small></div>
      <div th:text="${tpl.body}" style="margin:8px 0; color:#333;">ë³¸ë¬¸</div>
      <form th:action="@{|/admin/fcm/send/template/${tpl.id}|}" method="post">
        <button type="submit" class="small-btn">ê¸€ë¡œë²Œë¡œ ì „ì†¡</button>
      </form>
    </div>
  </div>
</div>

<script>
  // í¼ì—ì„œ data ì…ë ¥ì„ key=value,comma í˜•ì‹ì„ ì„œë²„ë¡œ ë³´ë‚´ëŠ” ê°„ë‹¨ ì²˜ë¦¬ (ì„œë²„ì—ì„œëŠ” Mapìœ¼ë¡œ ë°›ì„ ìˆ˜ ìˆë„ë¡)
  document.querySelector('form[th\\:action="@{/admin/fcm/send}"]')?.addEventListener('submit', function (ev) {
    // í¼ submit ì „ data í•„ë“œê°€ ìˆìœ¼ë©´ key=value ìŒìœ¼ë¡œ inputì„ ì—¬ëŸ¬ê°œ ë§Œë“¤ì–´ì„œ ì „ì†¡
    const dataStr = this.querySelector('input[name="data"]').value.trim();
    if (!dataStr) return; // ì—†ìŒ
    // parse into hidden inputs
    const pairs = dataStr.split(',').map(s => s.trim()).filter(Boolean);
    pairs.forEach(pair => {
      const [k, v] = pair.split('=').map(s => s?.trim());
      if (k && v !== undefined) {
        const input = document.createElement('input');
        input.type = 'hidden';
        // spring will interpret repeated params as map? safe approach: name="data[key]"
        input.name = 'data[' + k + ']';
        input.value = v;
        this.appendChild(input);
      }
    });
  });
</script>
</body>
</html>
